<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RGB QR Receiver - Experiment</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 { margin-bottom: 5px; color: #00d4ff; font-size: 1.4em; }
    .description {
      text-align: center;
      margin-bottom: 10px;
      color: #aaa;
      font-size: 0.9em;
    }
    #video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #333;
      border-radius: 8px;
    }
    #captureCanvas { display: none; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
      padding: 10px;
      background: #252540;
      border-radius: 8px;
    }
    .threshold-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .threshold-row label {
      width: 50px;
      font-size: 12px;
    }
    .threshold-row.red label { color: #ff6b6b; }
    .threshold-row.green label { color: #6bff6b; }
    .threshold-row.blue label { color: #6b6bff; }
    .threshold-row input[type="range"] { flex: 1; }
    .threshold-row .value {
      width: 35px;
      text-align: right;
      font-size: 12px;
      color: #00d4ff;
    }
    .channels {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .channel {
      text-align: center;
    }
    .channel canvas {
      border: 2px solid #333;
      border-radius: 4px;
      width: 100px;
      height: 100px;
    }
    .channel p {
      margin-top: 4px;
      font-size: 12px;
    }
    .channel .avg {
      font-size: 10px;
      color: #888;
    }
    .channel.red p { color: #ff6b6b; }
    .channel.green p { color: #6bff6b; }
    .channel.blue p { color: #6b6bff; }
    .results {
      width: 100%;
      max-width: 400px;
      padding: 15px;
      background: #252540;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
    }
    .result {
      margin: 8px 0;
      padding: 8px;
      border-radius: 4px;
      background: #1a1a2e;
    }
    .result.success { border-left: 3px solid #6bff6b; }
    .result.failure { border-left: 3px solid #ff6b6b; }
    .result .label { font-weight: bold; margin-bottom: 4px; }
    .result.red .label { color: #ff6b6b; }
    .result.green .label { color: #6bff6b; }
    .result.blue .label { color: #6b6bff; }
    .result .data {
      word-break: break-all;
      color: #fff;
    }
    .result .error { color: #ff6b6b; }
    .stats {
      margin-top: 10px;
      padding: 10px;
      background: #1a1a2e;
      border-radius: 4px;
      text-align: center;
    }
    .stats span { margin: 0 10px; }
    .stats .success-rate { color: #6bff6b; }
    button {
      margin: 10px;
      padding: 10px 20px;
      background: #00d4ff;
      color: #1a1a2e;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled {
      background: #333;
      color: #666;
    }
    .auto-row {
      text-align: center;
      margin-bottom: 5px;
    }
    #autoBtn {
      padding: 6px 12px;
      font-size: 12px;
      margin: 0;
    }
    #autoBtn.active {
      background: #6bff6b;
      color: #1a1a2e;
    }
  </style>
</head>
<body>
  <h1>RGB QR Receiver</h1>
  <p class="description">Point camera at the composite RGB QR code</p>

  <button id="startBtn">Start Camera</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="captureCanvas"></canvas>

  <div class="controls">
    <div class="auto-row">
      <button id="autoBtn" class="active">Auto Threshold: ON</button>
    </div>
    <div class="threshold-row red">
      <label>Red</label>
      <input type="range" id="thresholdR" min="20" max="235" value="128">
      <span class="value" id="thresholdRVal">128</span>
    </div>
    <div class="threshold-row green">
      <label>Green</label>
      <input type="range" id="thresholdG" min="20" max="235" value="128">
      <span class="value" id="thresholdGVal">128</span>
    </div>
    <div class="threshold-row blue">
      <label>Blue</label>
      <input type="range" id="thresholdB" min="20" max="235" value="128">
      <span class="value" id="thresholdBVal">128</span>
    </div>
  </div>

  <div class="channels">
    <div class="channel red">
      <canvas id="redChannel" width="100" height="100"></canvas>
      <p>Red</p>
      <p class="avg" id="avgR">avg: -</p>
    </div>
    <div class="channel green">
      <canvas id="greenChannel" width="100" height="100"></canvas>
      <p>Green</p>
      <p class="avg" id="avgG">avg: -</p>
    </div>
    <div class="channel blue">
      <canvas id="blueChannel" width="100" height="100"></canvas>
      <p>Blue</p>
      <p class="avg" id="avgB">avg: -</p>
    </div>
  </div>

  <div class="results">
    <div class="result red">
      <div class="label">Red Channel:</div>
      <div id="redResult" class="data">-</div>
    </div>
    <div class="result green">
      <div class="label">Green Channel:</div>
      <div id="greenResult" class="data">-</div>
    </div>
    <div class="result blue">
      <div class="label">Blue Channel:</div>
      <div id="blueResult" class="data">-</div>
    </div>
    <div class="stats">
      <span>Scans: <span id="scanCount">0</span></span>
      <span class="success-rate">Success: <span id="successRate">0/0/0</span></span>
    </div>
  </div>

  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const captureCanvas = document.getElementById('captureCanvas');
    const captureCtx = captureCanvas.getContext('2d', { willReadFrequently: true });
    const startBtn = document.getElementById('startBtn');

    const redCanvas = document.getElementById('redChannel');
    const greenCanvas = document.getElementById('greenChannel');
    const blueCanvas = document.getElementById('blueChannel');
    const redCtx = redCanvas.getContext('2d');
    const greenCtx = greenCanvas.getContext('2d');
    const blueCtx = blueCanvas.getContext('2d');

    const redResult = document.getElementById('redResult');
    const greenResult = document.getElementById('greenResult');
    const blueResult = document.getElementById('blueResult');
    const scanCountEl = document.getElementById('scanCount');
    const successRateEl = document.getElementById('successRate');

    // Threshold sliders
    const thresholdR = document.getElementById('thresholdR');
    const thresholdG = document.getElementById('thresholdG');
    const thresholdB = document.getElementById('thresholdB');
    const thresholdRVal = document.getElementById('thresholdRVal');
    const thresholdGVal = document.getElementById('thresholdGVal');
    const thresholdBVal = document.getElementById('thresholdBVal');
    const avgR = document.getElementById('avgR');
    const avgG = document.getElementById('avgG');
    const avgB = document.getElementById('avgB');

    const autoBtn = document.getElementById('autoBtn');

    function setAutoMode(enabled) {
      autoThreshold = enabled;
      autoBtn.textContent = `Auto Threshold: ${enabled ? 'ON' : 'OFF'}`;
      autoBtn.classList.toggle('active', enabled);
    }

    autoBtn.onclick = () => setAutoMode(!autoThreshold);

    thresholdR.oninput = () => { thresholdRVal.textContent = thresholdR.value; setAutoMode(false); };
    thresholdG.oninput = () => { thresholdGVal.textContent = thresholdG.value; setAutoMode(false); };
    thresholdB.oninput = () => { thresholdBVal.textContent = thresholdB.value; setAutoMode(false); };

    let autoThreshold = true; // Start with auto-threshold enabled
    let scanning = false;
    let scanCount = 0;
    let successCounts = { red: 0, green: 0, blue: 0 };

    startBtn.addEventListener('click', async () => {
      try {
        video.srcObject = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 720 }, height: { ideal: 720 } }
        });
        video.play();
        startBtn.disabled = true;
        startBtn.textContent = 'Scanning...';
        scanning = true;
        requestAnimationFrame(scanFrame);
      } catch (err) {
        console.error('Camera error:', err);
        alert('Failed to access camera: ' + err.message);
      }
    });

    // Otsu's method for automatic threshold calculation
    function otsuThreshold(histogram, total) {
      let sum = 0;
      for (let i = 0; i < 256; i++) sum += i * histogram[i];

      let sumB = 0, wB = 0, wF = 0;
      let maxVariance = 0, threshold = 128;

      for (let t = 0; t < 256; t++) {
        wB += histogram[t];
        if (wB === 0) continue;
        wF = total - wB;
        if (wF === 0) break;

        sumB += t * histogram[t];
        const mB = sumB / wB;
        const mF = (sum - sumB) / wF;
        const variance = wB * wF * (mB - mF) * (mB - mF);

        if (variance > maxVariance) {
          maxVariance = variance;
          threshold = t;
        }
      }
      return threshold;
    }

    function extractChannel(imageData, channel, manualThreshold) {
      const width = imageData.width;
      const height = imageData.height;
      const src = imageData.data;
      const total = width * height;

      // Build histogram for this channel
      const histogram = new Array(256).fill(0);
      let sum = 0;
      for (let i = 0; i < total; i++) {
        const val = src[i * 4 + channel];
        histogram[val]++;
        sum += val;
      }

      // Calculate threshold (auto or manual)
      const threshold = autoThreshold ? otsuThreshold(histogram, total) : manualThreshold;

      // Apply threshold
      const result = new Uint8ClampedArray(total * 4);
      for (let i = 0; i < total; i++) {
        const srcIdx = i * 4;
        const gray = src[srcIdx + channel] < threshold ? 0 : 255;
        result[srcIdx] = gray;
        result[srcIdx + 1] = gray;
        result[srcIdx + 2] = gray;
        result[srcIdx + 3] = 255;
      }

      const avg = Math.round(sum / total);
      return { imageData: new ImageData(result, width, height), avg, threshold };
    }

    function drawChannelPreview(channelData, ctx, displaySize) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = channelData.width;
      tempCanvas.height = channelData.height;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.putImageData(channelData, 0, 0);
      ctx.drawImage(tempCanvas, 0, 0, displaySize, displaySize);
    }

    function scanFrame() {
      if (!scanning) return;

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const size = Math.min(video.videoWidth, video.videoHeight);
        captureCanvas.width = size;
        captureCanvas.height = size;

        const offsetX = (video.videoWidth - size) / 2;
        const offsetY = (video.videoHeight - size) / 2;
        captureCtx.drawImage(video, offsetX, offsetY, size, size, 0, 0, size, size);

        const imageData = captureCtx.getImageData(0, 0, size, size);

        // Extract channels with per-channel thresholds
        const red = extractChannel(imageData, 0, parseInt(thresholdR.value));
        const green = extractChannel(imageData, 1, parseInt(thresholdG.value));
        const blue = extractChannel(imageData, 2, parseInt(thresholdB.value));

        // Update displays (show auto-calculated threshold if in auto mode)
        avgR.textContent = `avg: ${red.avg} | th: ${red.threshold}`;
        avgG.textContent = `avg: ${green.avg} | th: ${green.threshold}`;
        avgB.textContent = `avg: ${blue.avg} | th: ${blue.threshold}`;

        // Update sliders to show auto values
        if (autoThreshold) {
          thresholdR.value = red.threshold; thresholdRVal.textContent = red.threshold;
          thresholdG.value = green.threshold; thresholdGVal.textContent = green.threshold;
          thresholdB.value = blue.threshold; thresholdBVal.textContent = blue.threshold;
        }

        // Draw previews
        drawChannelPreview(red.imageData, redCtx, 100);
        drawChannelPreview(green.imageData, greenCtx, 100);
        drawChannelPreview(blue.imageData, blueCtx, 100);

        // Attempt to decode each channel
        const redCode = jsQR(red.imageData.data, red.imageData.width, red.imageData.height);
        const greenCode = jsQR(green.imageData.data, green.imageData.width, green.imageData.height);
        const blueCode = jsQR(blue.imageData.data, blue.imageData.width, blue.imageData.height);

        scanCount++;

        updateResult(redResult, redCode, 'red');
        updateResult(greenResult, greenCode, 'green');
        updateResult(blueResult, blueCode, 'blue');

        scanCountEl.textContent = scanCount;
        successRateEl.textContent = `${successCounts.red}/${successCounts.green}/${successCounts.blue}`;
      }

      requestAnimationFrame(scanFrame);
    }

    function updateResult(el, code, channel) {
      const resultDiv = el.parentElement;
      if (code) {
        el.textContent = code.data;
        el.classList.remove('error');
        resultDiv.classList.add('success');
        resultDiv.classList.remove('failure');
        successCounts[channel]++;
      } else {
        el.textContent = 'No QR detected';
        el.classList.add('error');
        resultDiv.classList.add('failure');
        resultDiv.classList.remove('success');
      }
    }

    console.log('RGB QR Receiver ready');
  </script>
</body>
</html>
