<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CMY QR Receiver - Experiment</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 { margin-bottom: 5px; color: #00d4ff; font-size: 1.4em; }
    .description {
      text-align: center;
      margin-bottom: 10px;
      color: #aaa;
      font-size: 0.85em;
    }
    #video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #333;
      border-radius: 8px;
    }
    #captureCanvas { display: none; }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
      padding: 10px;
      background: #252540;
      border-radius: 8px;
    }
    .threshold-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
    }
    .threshold-row label { width: 80px; color: #888; }
    .threshold-row input[type="range"] { flex: 1; }
    .threshold-row .value { width: 30px; text-align: right; color: #00d4ff; }
    .channels {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .channel { text-align: center; }
    .channel canvas {
      border: 2px solid #333;
      border-radius: 4px;
      width: 100px;
      height: 100px;
    }
    .channel p { margin-top: 4px; font-size: 11px; }
    .channel.cyan p { color: #00ffff; }
    .channel.magenta p { color: #ff00ff; }
    .channel.yellow p { color: #ffff00; }
    .channel .stats { font-size: 10px; color: #888; }
    .results {
      width: 100%;
      max-width: 400px;
      padding: 15px;
      background: #252540;
      border-radius: 8px;
      font-family: monospace;
      font-size: 11px;
    }
    .result {
      margin: 6px 0;
      padding: 6px;
      border-radius: 4px;
      background: #1a1a2e;
    }
    .result.success { border-left: 3px solid #6bff6b; }
    .result.failure { border-left: 3px solid #ff6b6b; }
    .result .label { font-weight: bold; margin-bottom: 3px; }
    .result.cyan .label { color: #00ffff; }
    .result.magenta .label { color: #ff00ff; }
    .result.yellow .label { color: #ffff00; }
    .result .data { word-break: break-all; color: #fff; font-size: 10px; }
    .stats-bar {
      margin-top: 10px;
      padding: 8px;
      background: #1a1a2e;
      border-radius: 4px;
      text-align: center;
      font-size: 11px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      background: #00d4ff;
      color: #1a1a2e;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled { background: #333; color: #666; }
    .note {
      margin-top: 10px;
      padding: 8px;
      background: #252540;
      border-radius: 4px;
      font-size: 10px;
      color: #888;
      max-width: 400px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>CMY QR Receiver (Fixed)</h1>
  <p class="description">Decodes additive CMY encoding (8 distinct colors → 3 bits)</p>

  <button id="startBtn">Start Camera</button>
  <video id="video" autoplay playsinline></video>
  <canvas id="captureCanvas"></canvas>

  <div class="controls">
    <div class="threshold-row">
      <label>R threshold</label>
      <input type="range" id="thresholdR" min="20" max="150" value="60">
      <span class="value" id="thresholdRVal">60</span>
    </div>
    <div class="threshold-row">
      <label>G threshold</label>
      <input type="range" id="thresholdG" min="20" max="150" value="60">
      <span class="value" id="thresholdGVal">60</span>
    </div>
    <div class="threshold-row">
      <label>B threshold</label>
      <input type="range" id="thresholdB" min="20" max="150" value="60">
      <span class="value" id="thresholdBVal">60</span>
    </div>
  </div>

  <div class="channels">
    <div class="channel cyan">
      <canvas id="cyanChannel" width="100" height="100"></canvas>
      <p>Cyan</p>
      <div class="stats" id="cyanStats">-</div>
    </div>
    <div class="channel magenta">
      <canvas id="magentaChannel" width="100" height="100"></canvas>
      <p>Magenta</p>
      <div class="stats" id="magentaStats">-</div>
    </div>
    <div class="channel yellow">
      <canvas id="yellowChannel" width="100" height="100"></canvas>
      <p>Yellow</p>
      <div class="stats" id="yellowStats">-</div>
    </div>
  </div>

  <div class="results">
    <div class="result cyan">
      <div class="label">Cyan Channel:</div>
      <div id="cyanResult" class="data">-</div>
    </div>
    <div class="result magenta">
      <div class="label">Magenta Channel:</div>
      <div id="magentaResult" class="data">-</div>
    </div>
    <div class="result yellow">
      <div class="label">Yellow Channel:</div>
      <div id="yellowResult" class="data">-</div>
    </div>
    <div class="stats-bar">
      Scans: <span id="scanCount">0</span> |
      Success: <span id="successRate">0/0/0</span>
    </div>
  </div>

  <div class="note">
    <strong>Additive CMY decoding:</strong><br>
    C present if G>th AND B>th. M present if R>th AND B>th. Y present if R>th AND G>th.<br>
    Each pixel classified → reconstruct 3 binary QR images → decode each.
  </div>

  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const captureCanvas = document.getElementById('captureCanvas');
    const captureCtx = captureCanvas.getContext('2d', { willReadFrequently: true });
    const startBtn = document.getElementById('startBtn');

    const cyanCanvas = document.getElementById('cyanChannel');
    const magentaCanvas = document.getElementById('magentaChannel');
    const yellowCanvas = document.getElementById('yellowChannel');
    const cyanCtx = cyanCanvas.getContext('2d');
    const magentaCtx = magentaCanvas.getContext('2d');
    const yellowCtx = yellowCanvas.getContext('2d');

    const thresholdR = document.getElementById('thresholdR');
    const thresholdG = document.getElementById('thresholdG');
    const thresholdB = document.getElementById('thresholdB');
    const thresholdRVal = document.getElementById('thresholdRVal');
    const thresholdGVal = document.getElementById('thresholdGVal');
    const thresholdBVal = document.getElementById('thresholdBVal');

    thresholdR.oninput = () => thresholdRVal.textContent = thresholdR.value;
    thresholdG.oninput = () => thresholdGVal.textContent = thresholdG.value;
    thresholdB.oninput = () => thresholdBVal.textContent = thresholdB.value;

    let scanning = false;
    let scanCount = 0;
    let successCounts = { cyan: 0, magenta: 0, yellow: 0 };

    startBtn.addEventListener('click', async () => {
      try {
        video.srcObject = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 720 }, height: { ideal: 720 } }
        });
        video.play();
        startBtn.disabled = true;
        startBtn.textContent = 'Scanning...';
        scanning = true;
        requestAnimationFrame(scanFrame);
      } catch (err) {
        alert('Camera error: ' + err.message);
      }
    });

    function scanFrame() {
      if (!scanning) return;

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const size = Math.min(video.videoWidth, video.videoHeight);
        captureCanvas.width = size;
        captureCanvas.height = size;

        const offsetX = (video.videoWidth - size) / 2;
        const offsetY = (video.videoHeight - size) / 2;
        captureCtx.drawImage(video, offsetX, offsetY, size, size, 0, 0, size, size);

        const imageData = captureCtx.getImageData(0, 0, size, size);
        const pixels = imageData.data;
        const total = size * size;

        const thR = parseInt(thresholdR.value);
        const thG = parseInt(thresholdG.value);
        const thB = parseInt(thresholdB.value);

        // Create binary images for C, M, Y channels
        const cyanData = new Uint8ClampedArray(total * 4);
        const magentaData = new Uint8ClampedArray(total * 4);
        const yellowData = new Uint8ClampedArray(total * 4);

        let cCount = 0, mCount = 0, yCount = 0;

        for (let i = 0; i < total; i++) {
          const idx = i * 4;
          const r = pixels[idx];
          const g = pixels[idx + 1];
          const b = pixels[idx + 2];

          // Decode CMY bits from RGB values
          // In additive CMY: C adds G and B, M adds R and B, Y adds R and G
          // So: C present = G>th AND B>th (and R relatively low)
          //     M present = R>th AND B>th (and G relatively low)
          //     Y present = R>th AND G>th (and B relatively low)

          // Simplified: check which components are elevated
          const hasR = r > thR;
          const hasG = g > thG;
          const hasB = b > thB;

          // C contributes to G and B (not R)
          // M contributes to R and B (not G)
          // Y contributes to R and G (not B)

          // Decode: If G and B are high but not R → likely C
          //         If R and B are high but not G → likely M
          //         If R and G are high but not B → likely Y
          //         Combinations give mixed colors

          // Better approach: solve the linear system
          // R = M + Y, G = C + Y, B = C + M (in terms of presence)
          // C = (G + B - R) / 2 > 0 means C present
          // M = (R + B - G) / 2 > 0 means M present
          // Y = (R + G - B) / 2 > 0 means Y present

          // But with thresholds, simpler: check if the combination matches expected patterns
          const cyanBit = (hasG && hasB) ? 1 : 0;
          const magentaBit = (hasR && hasB) ? 1 : 0;
          const yellowBit = (hasR && hasG) ? 1 : 0;

          if (cyanBit) cCount++;
          if (magentaBit) mCount++;
          if (yellowBit) yCount++;

          // Cyan channel: dark if cyan bit is set
          const cGray = cyanBit ? 0 : 255;
          cyanData[idx] = cGray;
          cyanData[idx + 1] = cGray;
          cyanData[idx + 2] = cGray;
          cyanData[idx + 3] = 255;

          // Magenta channel
          const mGray = magentaBit ? 0 : 255;
          magentaData[idx] = mGray;
          magentaData[idx + 1] = mGray;
          magentaData[idx + 2] = mGray;
          magentaData[idx + 3] = 255;

          // Yellow channel
          const yGray = yellowBit ? 0 : 255;
          yellowData[idx] = yGray;
          yellowData[idx + 1] = yGray;
          yellowData[idx + 2] = yGray;
          yellowData[idx + 3] = 255;
        }

        // Update stats
        document.getElementById('cyanStats').textContent = Math.round(cCount / total * 100) + '% dark';
        document.getElementById('magentaStats').textContent = Math.round(mCount / total * 100) + '% dark';
        document.getElementById('yellowStats').textContent = Math.round(yCount / total * 100) + '% dark';

        // Draw previews
        drawPreview(cyanData, size, cyanCtx, 100);
        drawPreview(magentaData, size, magentaCtx, 100);
        drawPreview(yellowData, size, yellowCtx, 100);

        // Try to decode
        const cyanCode = jsQR(cyanData, size, size);
        const magentaCode = jsQR(magentaData, size, size);
        const yellowCode = jsQR(yellowData, size, size);

        scanCount++;

        updateResult('cyanResult', cyanCode, 'cyan');
        updateResult('magentaResult', magentaCode, 'magenta');
        updateResult('yellowResult', yellowCode, 'yellow');

        document.getElementById('scanCount').textContent = scanCount;
        document.getElementById('successRate').textContent =
          successCounts.cyan + '/' + successCounts.magenta + '/' + successCounts.yellow;
      }

      requestAnimationFrame(scanFrame);
    }

    function drawPreview(data, srcSize, ctx, dstSize) {
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = srcSize;
      tempCanvas.height = srcSize;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.putImageData(new ImageData(data, srcSize, srcSize), 0, 0);
      ctx.drawImage(tempCanvas, 0, 0, dstSize, dstSize);
    }

    function updateResult(id, code, channel) {
      const el = document.getElementById(id);
      const resultDiv = el.parentElement;
      if (code) {
        el.textContent = code.data;
        resultDiv.classList.add('success');
        resultDiv.classList.remove('failure');
        successCounts[channel]++;
      } else {
        el.textContent = 'No QR detected';
        resultDiv.classList.add('failure');
        resultDiv.classList.remove('success');
      }
    }

    console.log('CMY QR Receiver (Fixed) ready');
  </script>
</body>
</html>
